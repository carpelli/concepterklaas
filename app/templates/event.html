{% extends "base.html" %}
{% block title %}{{ event.name }}{% endblock %}
{% block content %}
    <h1>{{ event.name }}</h1>
    {% if assignment_has_run %}
        <p>The assignment has been run. You can no longer add or remove participants.</p>
    {% endif %}
    {% with messages = get_flashed_messages() %}
        {% if messages %}<p>{{ messages[0] }}</p>{% endif %}
    {% endwith %}
    <h2>Participants</h2>
    <table>
        <thead>
            <tr>
                <th style="width: 60%;">Name</th>
                <th style="width: 20%;">Concept</th>
                <th style="width: 20%;">Link</th>
                {% if not assignment_has_run %}<th class="right"></th>{% endif %}
            </tr>
        </thead>
        <tbody>
            {% for p in event.participants %}
                <tr>
                    <td>
                        {% if p == event.host_participant %}
                            <a href="{{ url_for('participant_view', event_slug=event.slug, participant_slug=p.slug, token=p.token) }}">{{ p.name }}</a>
                            {{ star }}
                        {% else %}
                            {{ p.name }}
                        {% endif %}
                    </td>
                    <td>{{ check if p.concept else x }}</td>
                    <td class="copy-cell">
                        <a href="{{ url_for('participant_view', event_slug=event.slug, participant_slug=p.slug, token=p.token) }}"
                           class="copy-link">Copy</a>
                        <span class="copied-text">Copied!</span>
                    </td>
                    {% set confirm = "Are you sure you want to delete this participant? They have already submitted a concept." if p.concept else "" %}
                    {% if not assignment_has_run %}
                        <td class="right">
                            {{ delete_button(url_for('remove_participant', event_id=event.id, participant_id=p.id) , confirm=confirm) }}
                        </td>
                    {% endif %}
                </tr>
            {% else %}
                <tr>
                    <td rowspan="2">No one here yet!</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    <p></p>
    {% if not assignment_has_run %}
        <form method="post"
              action="{{ url_for('add_participant', event_id=event.id) }}">
            <div class="couple">
                <input type="text" id="name" name="name" required>
                <button type="submit">Add</button>
            </div>
            {% if event.host_participant is none %}
                <label style="position: relative; top: -.4rem;">
                    <input type="checkbox" name="is_host">
                    This is me
                </label>
            {% endif %}
        </form>
        <form class="text-center mt-1"
              method="post"
              action="{{ url_for('run_assignment', event_id=event.id) }}">
            <button type="submit"
                    {% if not can_run_assignment %}disabled title="Not all concepts have been submitted yet"{% endif %}>
                Run Assignment
            </button>
        </form>
    {% endif %}
    <hr class="mt-1" />
    <p>
        <a href="{{ url_for('admin') }}">Back to Admin</a>
    </p>
    <script>
        document.addEventListener('click', async (e) => {
          const copyLink = e.target.closest('a.copy-link');
          if (!copyLink) return;
          e.preventDefault();
          await navigator.clipboard.writeText(copyLink.href);
          copyLink.closest('.copy-cell').classList.add('copied');
        });
    </script>
{% endblock %}
